# 梦幻西游自动化脚本 - Mac版

## 项目概述

这是一个将触动精灵手机脚本移植到Mac平台的梦幻西游自动化脚本。项目保持了原有的触动精灵脚本结构和功能，同时适配了Mac平台的自动化框架，实现了游戏任务的自动化执行。

## 项目结构

mac_version/
├── main.py                 # 主程序入口
├── FreeGame_X.py           # 自动化框架模块（核心自动化功能实现）
├── compat.py               # 兼容性处理模块
├── find_color.py           # 图像识别模块
├── log_utils.py            # 日志工具模块
├── ui.py                   # 用户界面模块
├── page.txt                # 特征库文件（图像识别的特征点数据）
├── 直接启动脚本.command     # 一键启动脚本
├── Python依赖.txt         # Python依赖包列表
├── README.md              # 项目说明文档
├── venv/                  # Python虚拟环境
└── __pycache__/           # Python编译缓存
```


## 运行说明

### 使用一键启动脚本（推荐）

1. 打开项目文件夹 `mac_version/`
2. 找到并双击 `直接启动脚本.command` 文件
3. 系统会自动打开终端并启动脚本

**注意事项：**
- 首次运行可能需要授权辅助功能权限
- 确保游戏窗口已打开并可见
- 脚本会自动处理虚拟环境和依赖

### 手动运行（可选）

1. **进入虚拟环境**
```bash
cd mac_version/
source venv/bin/activate
```

2. **运行脚本**
```bash
python main.py
```

3. **退出虚拟环境**
```bash
deactivate
```

**注意：** 依赖包已预先安装在虚拟环境中，无需额外安装。

### 界面操作
- **任务选择**：选择要执行的任务类型（抓鬼、师门、采集花草、挖掘矿石、测试）
- **参数设置**：根据任务类型设置相应参数（如抓鬼轮数、采集次数、采集地点等）
- **启动控制**：点击界面按钮或使用键盘快捷键启动自动化脚本

### 键盘快捷键
- **左方向键**：暂停/继续脚本执行
- **右方向键**：停止脚本执行
- **上方向键**：开始执行任务

### 功能说明

#### 抓鬼任务
- 自动识别并关闭各种弹窗
- 自动点击抓鬼任务按钮
- 智能识别并点击捉鬼目标
- 支持设置抓鬼轮数
- 任务完成后自动结束

#### 师门任务
- 自动识别并完成师门任务流程
- 自动处理商城购买需求
- 智能关闭节日窗口和百宝阁窗口
- 支持对话自动跳过
- 支持自动战斗模式

#### 采集任务
- 支持花草和矿石两种采集类型
- 可选择不同采集地图（如东海等）
- 支持设置采集次数
- 智能寻找采集目标
- 自动处理采集过程中的各种情况

#### 测试功能
- 提供特征点测试功能
- 支持范围随机点击测试
- 用于验证图像识别和点击功能

## 技术特点

### 1. 核心技术栈
- **Python**：主要开发语言
- **OpenCV**：图像识别和处理
- **PyAutoGUI**：鼠标键盘自动化操作
- **PyQt5**：图形用户界面开发
- **Pillow**：图像处理和分析

### 2. 自动化框架
- 基于FreeGame-X自动化框架开发
- 支持多种点击模式（普通点击、精确点击、范围随机点击等）
- 智能图像识别和特征点匹配
- 可配置的点击延迟和偏移量

### 3. 性能优化
- 特征库缓存机制，提高加载速度
- 优化的图像识别算法，提高识别准确率
- 智能的任务执行流程，减少不必要的操作
- 完善的错误处理和日志记录

### 4. 兼容性
- 适配Mac平台的自动化需求
- 支持不同屏幕分辨率
- 兼容macOS 10.15及以上版本
- 保持与原触动精灵脚本的功能一致性

## 配置说明

### 特征库配置
- 特征库文件为`page.txt`，包含脚本所需的所有图像识别特征点
- 如需添加新的特征点，可以编辑此文件
- 特征点格式保持与触动精灵脚本的兼容性

### 任务参数配置
- 抓鬼轮数：在UI界面中设置
- 采集次数：在UI界面中设置
- 采集地点：在UI界面中选择（如东海等）

## 任务规则配置

### 规则定义格式

在`main.py`文件中，任务规则通过字典形式定义，每个任务对应一个`Action`对象，包含一系列操作序列。

```python
'task_name': Action('t.feature_name').action1().action2().sleep(1000)
```

### Action类方法说明

| 方法名 | 描述 | 示例 |
|--------|------|------|
| `click()` | 点击特征点 | `.click()` |
| `click(x, y)` | 点击特征点附近的偏移位置 | `.click(50, 20)` |
| `sleep(ms)` | 延迟指定毫秒数 | `.sleep(1500)` |
| `cs(n)` | 重复点击n次 | `.cs(2)` |
| `s(n)` | 短时间随机延迟（n个单位） | `.s(1)` |
| `uncheck(func)` | 取消检查指定的流控函数 | `.uncheck(flow_control.滑动任务)` |
| `before(func)` | 在执行前检查指定的流控函数 | `.before(flow_control.判断次数0)` |

### 规则添加示例

以下是添加新任务规则的步骤：

1. **在特征库中定义特征点**
   首先在`page.txt`文件中添加新的特征点定义：
   ```
new_feature_name={0x8e684b,"0|5|0x916c4c,1|1|0x896042",80,293,121,307,130};
   ```
   
   特征点定义格式说明：
   ```
feature_name={color_id,"offset_x|offset_y|color_value,...",similarity,start_x,start_y,end_x,end_y};
   ```
   - `color_id`: 主颜色ID
   - `offset_x|offset_y|color_value,...`: 特征点的颜色偏移矩阵
   - `similarity`: 相似度阈值（百分比）
   - `start_x|start_y`: 搜索区域左上角坐标
   - `end_x|end_y`: 搜索区域右下角坐标

2. **在main.py中添加任务规则**
   在任务字典中添加新的任务配置：
   ```python
   'new_task': Action('t.new_feature_name').click().sleep(1000).cs(2)
   ```

3. **在界面中添加任务选择**
   如果需要在UI中显示该任务，还需要在界面配置部分添加相应的选项。

### 现有规则示例解析

```python
'测试点': Action('t.测试点').click().sleep(1500)
```
- 任务名称：测试点
- 操作：点击特征点"测试点"，然后延迟1500毫秒

```python
'抓鬼任务1': Action('t.抓鬼任务').sleep(1000).click().cs(2).sleep(3000)
```
- 任务名称：抓鬼任务1
- 操作：延迟1000毫秒 → 点击特征点"抓鬼任务" → 重复点击2次 → 延迟3000毫秒

```python
'点击捉鬼': Action('t.点击捉鬼').click(80, 30).sleep(1500).click(50, 20).s(2).cs(1).sleep(900).uncheck(flow_control.滑动任务)
```
- 任务名称：点击捉鬼
- 操作：点击特征点"点击捉鬼"附近(+80,+30)的位置 → 延迟1500毫秒 → 点击附近(+50,+20)的位置 → 短延迟2个单位 → 重复点击1次 → 延迟900毫秒 → 取消检查"滑动任务"流控函数

### 规则编写注意事项

1. **特征点名称**：确保与`page.txt`中的特征点名称一致
2. **操作顺序**：按照实际游戏流程设置操作顺序
3. **延迟设置**：根据游戏响应速度合理设置延迟时间
4. **重复点击**：对于需要多次点击的场景使用`cs()`方法
5. **流控函数**：根据需要添加或取消流控函数检查
6. **偏移点击**：使用`click(x, y)`方法实现精确位置点击

## 流控函数说明

流控函数用于控制任务执行的条件和流程，主要在`流控函数.py`文件中定义。

### 常用流控函数

- `flow_control.判断次数0`：检查任务执行次数
- `flow_control.滑动任务`：检查是否需要执行滑动操作
- 更多流控函数可以在`流控函数.py`文件中查看和扩展

### 使用流控函数

```python
'任务名称': Action('t.feature').before(flow_control.判断次数0).click().uncheck(flow_control.滑动任务)
```

- `before()`：在执行任务前检查流控函数
- `uncheck()`：取消执行过程中的流控函数检查
```

## 注意事项

1. **权限要求**：
   - 首次运行可能需要授权辅助功能权限
   - 系统偏好设置 > 安全性与隐私 > 辅助功能 > 添加终端应用

2. **游戏设置**：
   - 确保游戏窗口在前台且完全可见
   - 建议将游戏分辨率设置为与屏幕分辨率匹配
   - 避免在游戏窗口上覆盖其他应用程序

3. **运行环境**：
   - 稳定的网络连接
   - 足够的系统资源（建议至少8GB RAM）
   - 避免在脚本运行时操作鼠标和键盘

4. **安全使用**：
   - 遵守游戏规则和相关法律法规
   - 合理使用自动化功能，避免过度依赖
   - 定期检查脚本更新和游戏更新

## 故障排除

### 常见问题

1. **脚本无法启动**
   - 检查Python虚拟环境是否正常
   - 确保所有依赖包已正确安装
   - 查看终端输出的错误信息

2. **权限问题**
   - 系统偏好设置 > 安全性与隐私 > 辅助功能
   - 添加终端应用到允许控制您的电脑列表
   - 重启终端后重新运行脚本

3. **图像识别失败**
   - 确保游戏窗口可见且未被遮挡
   - 检查特征库文件`page.txt`是否存在且完整
   - 尝试调整游戏窗口的大小和位置

4. **点击操作无效**
   - 检查辅助功能权限是否已正确授权
   - 确保游戏窗口在前台
   - 尝试重启脚本和游戏

## 开发说明

### 项目结构
- `main.py`：主程序入口，负责界面和任务流程控制
- `FreeGame_X.py`：自动化框架核心，实现鼠标键盘操作和图像识别
- `find_color.py`：图像识别算法实现
- `ui.py`：用户界面实现
- `page.txt`：特征库文件

### 自定义开发
- 如需添加新功能，可以在`main.py`中扩展任务逻辑
- 如需添加新的图像识别特征点，可以编辑`page.txt`文件
- 自动化操作可以使用`FreeGame_X.py`中提供的API

### 依赖管理
- 依赖包列表保存在`Python依赖.txt`文件中
- 项目使用虚拟环境`venv`管理依赖
- 如需添加新依赖，请使用虚拟环境的pip安装

## 许可证

本项目仅供学习和研究使用，请遵守相关法律法规和游戏规则。

## 在其他Mac电脑上运行

1. 将完整的 `mac_version` 文件夹复制到目标Mac电脑上
2. 确保目标电脑运行的是macOS 10.15或更高版本
3. 使用相同的启动方式（双击`直接启动脚本.command`）运行脚本

### 注意事项

- 项目包含完整的虚拟环境，无需在目标电脑上安装Python
- 首次在新电脑上运行时，可能需要授权辅助功能权限
- 建议使用高速存储设备传输项目文件
- 传输完成后，确保所有文件和文件夹的权限设置正确

## 更新日志

### 最新版本
- 适配Mac平台的自动化操作
- 实现抓鬼、师门、采集等任务的自动化
- 提供用户友好的图形界面
- 支持键盘快捷键控制

### 历史版本
- 原始触动精灵手机脚本移植
- 图像识别算法优化
- 自动化框架完善
